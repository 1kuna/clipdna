version: '3.8'

services:
  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: clipdna-desktop-worker
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-clipdna}:${POSTGRES_PASSWORD}@${NAS_HOST:?required}:5432/${POSTGRES_DB:-clipdna_desktop}
      REDIS_URL: redis://${NAS_HOST}:6379/0
      FAISS_INDEX_PATH: /data/index/faiss/video.index
      VIDEOS_PATH: /data/videos
      EMBEDDINGS_PATH: /data/embeddings
      MODEL_PATH: /app/models/visil
      FRAME_RATE: ${FRAME_RATE:-1}
      BATCH_SIZE: ${BATCH_SIZE:-32}
      NUM_WORKERS: ${NUM_WORKERS:-1}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ${NAS_MOUNT_PATH:?required}:/data
      - ./worker/models:/app/models
      - ../shared:/app/shared:ro
    # For local development without NFS:
    # volumes:
    #   - /path/to/local/data:/data
